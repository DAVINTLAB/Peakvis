<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <link rel="stylesheet" type="text/css"
        href="https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css" />
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css"
        integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous">
</head>

<body>
    <script src="https://d3js.org/d3.v3.min.js"></script>
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
    <script src="http://code.jquery.com/jquery-1.8.3.min.js"></script>

    <nav class="navbar navbar-expand-lg navbar-light bg-light">
        <a class="navbar-brand" href="layout.html">Teste Layout</a>
        <button class="navbar-toggler" data-toggle="collapse" data-target="#navbarSupportedContent"
            aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
            <span class="navbar-toggler-icon"></span>
        </button>

        <div class="collapse navbar-collapse" id="navbarSupportedContent">
            <ul class="navbar-nav mr-auto">
                <li class="nav-item">
                    <a class="nav-link" href="#">Visualização</a>
                </li>
            </ul>
            <div class="form-inline my-2 my-lg-0">
                <button class="btn btn-dark" onclick="pagGithub()">
                    <span class="icon">
                        <i class="fa fa-github"></i>
                    </span>
                    <span>
                        GitHub
                    </span>
                </button>
            </div>
        </div>
    </nav>

    <form name="formulario">
        <div class="row">
            <div class="col">
                <input name="dadoss" type="text" class="form-control" placeholder="Dados">
            </div>
            <div class="col">
                <input name="videoo" type="text" class="form-control" placeholder="Vídeo">
            </div>
            <div class="col">
                <input name="frequenciaa" type="text" class="form-control" placeholder="Frequência (em minutos)">
            </div>
        </div>
        <button type="submit" class="btn btn-primary" onclick="plot(); return false">Submit</button>
    </form>

    <div id="plotly_div_id"></div>
    <div id="plotly_div_id_2"></div>
    <div id="video_container"></div>

    <script>

        function pagGithub() {
            window.location.assign("https://github.com/DAVINTLAB");
        }

        function plotVideo() {
            sessionStorage.nomeVideo = document.formulario.videoo.value;
            $("#video_container").load("loadVideo.html");
        }

        function plot() {
            d3.json("/DATA/dados/" + document.formulario.dadoss.value, function (data) {

                //criação dos eixos X e Y
                horariosData = data;
                var horarios = [];
                var ex = [];
                var ey = [];
                var count = 0;
                for (var i = 0; i < horariosData.length; i++) {
                    horarios.unshift(new Date(Date.parse(horariosData[i].created_at)));
                }
                var started_time = horarios[0];
                started_time.setMinutes(started_time.getMinutes() + parseInt(document.formulario.frequenciaa.value, 10));
                for (var i = 0; i < horarios.length; i++) {
                    if (horarios[i] >= started_time) {
                        ey.push(count);
                        count = 1;
                        started_time = horarios[i];
                        ex.push(started_time);
                        started_time.setMinutes(started_time.getMinutes() + parseInt(document.formulario.frequenciaa.value, 10));
                    } else {
                        count = count + 1;
                    }
                }

                //plot do grafico
                let plotDiv = document.getElementById("plotly_div_id");
                let plotDiv2 = document.getElementById("plotly_div_id_2");
                console.log(49323/ey.length);

                let cnt = 0;
                let cntData2 = 0;
                let taPausado = true;
                let media = 0;
                let eixox = [];
                let eixoy = [];

                let g1 = {
                    x: ex,
                    y: ey,
                    mode: 'lines',
                    name: 'Gráfico Total',
                    line: { color: '#80CAF6' }
                }

                let g2 = {
                    x: [ex[0]],
                    y: [ey[0]],
                    mode: 'lines',
                    name: 'Progresso',
                    line: { color: '#E80505' }
                }

                var data = [g1, g2];

                var data2 = [{
                    x: [ex[0]],
                    y: [ey[0]],
                    mode: 'lines',
                    line: { color: '#F555D5' }
                }]

                Plotly.newPlot(plotDiv, data);
                Plotly.newPlot(plotDiv2, data2);
                plotVideo();

                var interval = setInterval(function () {

                    if (!taPausado) {
                        var time = ex[cnt];

                        eixox.push(time);
                        eixoy.push(ey[cnt]);

                        if (cntData2 > 10) {
                            eixox.shift();
                            eixoy.shift();
                        }

                        let data2 = [{
                            x: eixox,
                            y: eixoy,
                            mode: 'lines',
                            line: { color: 'F555D5' }
                        }]

                        media = cnt - Math.round(document.getElementById("video").currentTime);

                        if (media == 1 || media == 0) {
                            var olderTime = time.setSeconds(time.getSeconds() - 1);
                            var futureTime = time.setSeconds(time.getSeconds() + 1);
                        } else {
                            cnt = Math.round(document.getElementById("video").currentTime) + 1;
                            var olderTime = time.setSeconds(time.getSeconds() - (media * -1));
                            var futureTime = time.setSeconds(time.getSeconds() + (media * -1));
                            //====== Hotfix para o grafico rosa ====== //
                            eixox = [ex[cnt - 1], ex[cnt]];
                            eixoy = [ey[cnt - 1], ey[cnt]];
                            cntData2 = 0;
                            //====== Hotfix para o grafico azul ====== //
                            g2 = {
                                x: [ex[cnt]],
                                y: [ey[cnt]],
                                mode: 'lines',
                                name: 'Progresso',
                                line: { color: '#E80505' }
                            }
                            
                            Plotly.newPlot(plotDiv, [g1, g2]);
                        }

                        var minuteView = {
                            xaxis: {
                                type: 'date',
                                range: [olderTime, futureTime]
                            }
                        };

                        var update = {
                            x: [[], [ex[cnt]]],
                            y: [[], [ey[cnt]]]
                        }

                        Plotly.newPlot(plotDiv2, data2);
                        Plotly.relayout(plotDiv, minuteView);
                        Plotly.extendTraces(plotDiv, update, [0, 1])
                        cnt = cnt + 1;
                        cntData2 = cntData2 + 1;

                        //serve para fazer o autoscale automaticamente (porque se nao fica ilegivel)
                        document.querySelector('[data-title="Autoscale"]').click()
                    }

                    document.getElementById("video").onpause = function () {
                        taPausado = true;
                    }

                    document.getElementById("video").onplay = function () {
                        taPausado = false;
                    }
                }, 1000);
            })
        }
    </script>
</body>