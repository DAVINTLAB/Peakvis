<!doctype html>

<html lang="en">

<head>
  <meta charset="utf-8">
  <title>bars</title>
  <style>
    .axis {
      font: 10px sans-serif;
    }

    .axis path,
    .axis line {
      fill: none;
      stroke: #000;
      shape-rendering: crispEdges;
    }

    .axis--y path {
      display: none;
    }

    .bar {
      fill: #7200ac;
      fill-opacity: .9;
    }

    .wld {
      fill: #0bb6e0;
    }

    .chart-title {
      margin-bottom: 0;
    }

    .source {
      margin-top: 0;
      font-size: 11px;
    }
  </style>
</head>

<body>
  <div class="wrapper">
    <div class="chart"></div>
  </div>
  <script src="//d3js.org/d3.v4.0.0-alpha.28.min.js"></script>
  <script>
    'use strict';

    const margin = { top: 20, right: 30, bottom: 40, left: 260 };
    const width = 960 - margin.left - margin.right;
    const height = 400 - margin.top - margin.bottom;
    const percentFormat = d3.format('.0%');
    const leftPadding = 5;

    const delay = function (d, i) {
      return i * 40;
    };

    function sortData(data) {
      return data.sort((a, b) => b.value - a.value);
    }

    function xAccessor(d) {
      return d.value;
    }

    function yAccessor(d) {
      return d.usuario;
    }

    const xScale = d3.scaleLinear()
      .range([0, width])
      .domain([0, 1]);

    const yScale = d3.scaleBand()
      .rangeRound([0, height], 0.1)
      .padding(0.1);

    function drawXAxis(el) {
      el.append('g')
        .attr('class', 'axis axis--x')
        .attr('transform', `translate(${leftPadding},${height})`)
        .call(d3.axisBottom(xScale).tickFormat(percentFormat));
    }

    function drawYAxis(el, data, t) {
      let axis = el.select('.axis--y');
      if (axis.empty()) {
        axis = el.append('g')
          .attr('class', 'axis axis--y');
      }

      axis.transition(t)
        .call(d3.axisLeft(yScale))
        .selectAll('g')
        .delay(delay);
    }

    function drawBars(el, data, t) {
      let barsG = el.select('.bars-g');
      if (barsG.empty()) {
        barsG = el.append('g')
          .attr('class', 'bars-g');
      }

      const bars = barsG
        .selectAll('.bar')
        .data(data, yAccessor);
      bars.exit()
        .remove();
      bars.enter()
        .append('rect')
        .attr('class', 'bar')
        .attr('x', leftPadding)
        .merge(bars).transition(t)
        .attr('y', d => yScale(yAccessor(d)))
        .attr('width', d => xScale(xAccessor(d)))
        .attr('height', yScale.bandwidth())
        .delay(delay);
    }

    const svg = d3.select('.chart').append('svg')
      .attr('width', width + margin.left + margin.right)
      .attr('height', height + margin.top + margin.bottom)
      .append('g')
      .attr('transform', `translate(${margin.left},${margin.top})`);

    let data = [];
    for (let j = 0; j < 12; j++) {
      let value = Math.random();
      let aux = "teste" + j;
      const newEntry = {
        value,
        usuario: aux
      };
      data.push(newEntry);
    }

    let selectedData = sortData(data);
    let geoAreas = selectedData.map(yAccessor);

    yScale.domain(geoAreas);
    drawXAxis(svg, selectedData);
    drawYAxis(svg, selectedData);
    drawBars(svg, selectedData);

    const interval = d3.interval(() => {
      const t = d3.transition().duration(400);

      selectedData = sortData(data);
      yScale.domain(selectedData.map(yAccessor));
      drawYAxis(svg, selectedData, t);
      drawBars(svg, selectedData, t);

      for (let j = 0; j < 12; j++) {
        data[j].value = Math.random();
      }
    }, 1000);    
  </script>
</body>

</html>